// translations.js - Multi-language support system
export const translations = {
    vi: {
        // Header & Navigation
        search: 'Tìm kiếm',
        dark_mode: 'Chế độ tối',
        language: 'Ngôn ngữ',
        
        // Categories
        categories: 'Danh Mục',
        all: 'Tất cả',
        tea: 'Trà',
        coffee: 'Cà phê',
        smoothie: 'Sinh tố',
        snacks: 'Đồ ăn nhẹ',
        
        // Menu & Products
        menu: 'Thực Đơn',
        add_to_cart: 'Thêm vào giỏ',
        price: 'Giá',
        description: 'Mô tả',
        available: 'Có sẵn',
        out_of_stock: 'Hết hàng',
        no_results: 'Không tìm thấy sản phẩm nào',
        
        // Cart & Ordering
        cart: 'Giỏ Hàng',
        empty_cart: 'Giỏ hàng trống',
        clear_cart: 'Xóa tất cả',
        subtotal: 'Tạm tính',
        discount: 'Giảm giá',
        total: 'Tổng tiền',
        quantity: 'Số lượng',
        
        // Customization
        sugar: 'Đường',
        ice: 'Đá',
        toppings: 'Topping',
        
        // Order Types
        dine_in: 'Uống Tại Chỗ',
        delivery: 'Đặt Giao Hàng',
        table_number: 'Số bàn',
        customer_name: 'Tên khách hàng',
        phone: 'Số điện thoại',
        address: 'Địa chỉ giao hàng',
        note: 'Ghi chú',
        submit_order: 'Gửi Đơn Hàng',
        
        // Order Status
        order_status: 'Trạng Thái Đơn Hàng',
        order_placed: 'Đã đặt hàng',
        preparing: 'Đang chuẩn bị',
        ready: 'Đã sẵn sàng',
        delivered: 'Đã giao',
        
        // Promotions
        promotions: 'Khuyến Mãi Hôm Nay',
        apply: 'Áp dụng',
        
        // Feedback
        feedback: 'Đánh Giá & Phản Hồi',
        rating: 'Đánh giá',
        submit_feedback: 'Gửi Phản Hồi',
        
        // Chat & Support
        support: 'Hỗ Trợ',
        welcome_message: 'Xin chào! Tôi có thể giúp gì cho bạn?',
        
        // Notifications
        success: 'Thành công',
        error: 'Lỗi',
        warning: 'Cảnh báo',
        info: 'Thông tin',
        
        // Common Actions
        save: 'Lưu',
        cancel: 'Hủy',
        delete: 'Xóa',
        edit: 'Chỉnh sửa',
        add: 'Thêm',
        update: 'Cập nhật',
        confirm: 'Xác nhận',
        close: 'Đóng',
        
        // Time & Date
        today: 'Hôm nay',
        yesterday: 'Hôm qua',
        this_week: 'Tuần này',
        this_month: 'Tháng này',
        
        // Admin Panel
        dashboard: 'Dashboard',
        orders: 'Đơn Hàng',
        menu_management: 'Quản Lý Thực Đơn',
        analytics: 'Báo Cáo',
        promotions_management: 'Quản Lý Khuyến Mãi',
        feedback_management: 'Phản Hồi',
        chat_management: 'Tin Nhắn',
        settings: 'Cài Đặt',
        
        // Order Management
        pending: 'Đang chờ',
        processing: 'Đang xử lý',
        completed: 'Hoàn thành',
        archived: 'Lưu trữ',
        cancelled: 'Đã hủy',
        
        // Payment
        paid: 'Đã thanh toán',
        unpaid: 'Chưa thanh toán',
        payment_method: 'Phương thức thanh toán',
        cash: 'Tiền mặt',
        card: 'Thẻ',
        transfer: 'Chuyển khoản',
        
        // Statistics
        total_orders: 'Tổng đơn hàng',
        total_revenue: 'Tổng doanh thu',
        average_rating: 'Đánh giá trung bình',
        new_customers: 'Khách hàng mới',
        
        // Error Messages
        network_error: 'Lỗi kết nối mạng',
        server_error: 'Lỗi máy chủ',
        validation_error: 'Dữ liệu không hợp lệ',
        permission_denied: 'Không có quyền truy cập',
        not_found: 'Không tìm thấy',
        
        // Success Messages
        order_placed_success: 'Đặt hàng thành công',
        payment_success: 'Thanh toán thành công',
        update_success: 'Cập nhật thành công',
        delete_success: 'Xóa thành công',
        
        // Offline
        offline: 'Chế độ ngoại tuyến',
        online: 'Đã kết nối',
        sync_pending: 'Đang đồng bộ...',
        
        // PWA
        install_app: 'Cài đặt ứng dụng',
        update_available: 'Có bản cập nhật mới'
    },
    
    en: {
        // Header & Navigation
        search: 'Search',
        dark_mode: 'Dark Mode',
        language: 'Language',
        
        // Categories
        categories: 'Categories',
        all: 'All',
        tea: 'Tea',
        coffee: 'Coffee',
        smoothie: 'Smoothie',
        snacks: 'Snacks',
        
        // Menu & Products
        menu: 'Menu',
        add_to_cart: 'Add to Cart',
        price: 'Price',
        description: 'Description',
        available: 'Available',
        out_of_stock: 'Out of Stock',
        no_results: 'No products found',
        
        // Cart & Ordering
        cart: 'Cart',
        empty_cart: 'Cart is empty',
        clear_cart: 'Clear all',
        subtotal: 'Subtotal',
        discount: 'Discount',
        total: 'Total',
        quantity: 'Quantity',
        
        // Customization
        sugar: 'Sugar',
        ice: 'Ice',
        toppings: 'Toppings',
        
        // Order Types
        dine_in: 'Dine In',
        delivery: 'Delivery',
        table_number: 'Table Number',
        customer_name: 'Customer Name',
        phone: 'Phone Number',
        address: 'Delivery Address',
        note: 'Note',
        submit_order: 'Submit Order',
        
        // Order Status
        order_status: 'Order Status',
        order_placed: 'Order Placed',
        preparing: 'Preparing',
        ready: 'Ready',
        delivered: 'Delivered',
        
        // Promotions
        promotions: 'Today\'s Promotions',
        apply: 'Apply',
        
        // Feedback
        feedback: 'Feedback & Reviews',
        rating: 'Rating',
        submit_feedback: 'Submit Feedback',
        
        // Chat & Support
        support: 'Support',
        welcome_message: 'Hello! How can I help you?',
        
        // Notifications
        success: 'Success',
        error: 'Error',
        warning: 'Warning',
        info: 'Information',
        
        // Common Actions
        save: 'Save',
        cancel: 'Cancel',
        delete: 'Delete',
        edit: 'Edit',
        add: 'Add',
        update: 'Update',
        confirm: 'Confirm',
        close: 'Close',
        
        // Time & Date
        today: 'Today',
        yesterday: 'Yesterday',
        this_week: 'This Week',
        this_month: 'This Month',
        
        // Admin Panel
        dashboard: 'Dashboard',
        orders: 'Orders',
        menu_management: 'Menu Management',
        analytics: 'Analytics',
        promotions_management: 'Promotions',
        feedback_management: 'Feedback',
        chat_management: 'Messages',
        settings: 'Settings',
        
        // Order Management
        pending: 'Pending',
        processing: 'Processing',
        completed: 'Completed',
        archived: 'Archived',
        cancelled: 'Cancelled',
        
        // Payment
        paid: 'Paid',
        unpaid: 'Unpaid',
        payment_method: 'Payment Method',
        cash: 'Cash',
        card: 'Card',
        transfer: 'Transfer',
        
        // Statistics
        total_orders: 'Total Orders',
        total_revenue: 'Total Revenue',
        average_rating: 'Average Rating',
        new_customers: 'New Customers',
        
        // Error Messages
        network_error: 'Network error',
        server_error: 'Server error',
        validation_error: 'Invalid data',
        permission_denied: 'Permission denied',
        not_found: 'Not found',
        
        // Success Messages
        order_placed_success: 'Order placed successfully',
        payment_success: 'Payment successful',
        update_success: 'Updated successfully',
        delete_success: 'Deleted successfully',
        
        // Offline
        offline: 'Offline',
        online: 'Online',
        sync_pending: 'Syncing...',
        
        // PWA
        install_app: 'Install App',
        update_available: 'Update Available'
    }
};

// Current language state
export let currentLanguage = 'vi';

// Translation function
export function t(key, language = currentLanguage) {
    const keys = key.split('.');
    let value = translations[language];
    
    for (const k of keys) {
        value = value?.[k];
        if (value === undefined) break;
    }
    
    // Fallback to Vietnamese if English translation not found
    if (value === undefined && language === 'en') {
        value = translations.vi;
        for (const k of keys) {
            value = value?.[k];
            if (value === undefined) break;
        }
    }
    
    // Return key if translation not found
    return value !== undefined ? value : key;
}

// Set language
export function setLanguage(lang) {
    if (translations[lang]) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);
        document.documentElement.lang = lang;
        
        // Update page title based on language
        if (lang === 'en') {
            document.title = document.title.replace('PHỐ ĐI LẠI LÝ NHÂN', 'WALKING STREET LY NHAN');
        } else {
            document.title = document.title.replace('WALKING STREET LY NHAN', 'PHỐ ĐI LẠI LÝ NHÂN');
        }
        
        return true;
    }
    return false;
}

// Get current language
export function getCurrentLanguage() {
    return currentLanguage;
}

// Get available languages
export function getAvailableLanguages() {
    return Object.keys(translations);
}

// Translate page content
export function translatePage() {
    const elements = document.querySelectorAll('[data-translate]');
    
    elements.forEach(element => {
        const key = element.getAttribute('data-translate');
        const translation = t(key);
        
        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            if (element.type === 'submit' || element.type === 'button') {
                element.value = translation;
            } else {
                element.placeholder = translation;
            }
        } else {
            element.textContent = translation;
        }
    });
    
    // Translate dynamic content
    translateDynamicContent();
}

// Translate dynamic content (content that might be added after page load)
function translateDynamicContent() {
    // Update meta tags
    const metaDescription = document.querySelector('meta[name="description"]');
    if (metaDescription) {
        if (currentLanguage === 'en') {
            metaDescription.content = 'Order drinks and snacks online at Walking Street Ly Nhan. Fast delivery, best quality.';
        } else {
            metaDescription.content = 'Đặt hàng đồ uống và đồ ăn nhẹ online tại PHỐ ĐI LẠI LÝ NHÂN. Giao hàng nhanh chóng, chất lượng tốt nhất.';
        }
    }
    
    // Update aria-labels
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.setAttribute('aria-label', t('search'));
    }
    
    // Update button titles
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.title = t('dark_mode');
    }
    
    const langToggle = document.getElementById('langToggle');
    if (langToggle) {
        langToggle.title = t('language');
    }
}

// Format currency based on language
export function formatCurrency(amount, language = currentLanguage) {
    if (language === 'en') {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        }).format(amount);
    } else {
        return `${amount.toLocaleString('vi-VN')} VNĐ`;
    }
}

// Format date based on language
export function formatDate(date, language = currentLanguage) {
    const locale = language === 'en' ? 'en-US' : 'vi-VN';
    return new Intl.DateTimeFormat(locale, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).format(date);
}

// Format relative time (e.g., "2 hours ago")
export function formatRelativeTime(date, language = currentLanguage) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (language === 'en') {
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        return formatDate(date, language);
    } else {
        if (diffMins < 1) return 'Vừa xong';
        if (diffMins < 60) return `${diffMins} phút trước`;
        if (diffHours < 24) return `${diffHours} giờ trước`;
        if (diffDays < 7) return `${diffDays} ngày trước`;
        return formatDate(date, language);
    }
}

// Get plural form (mainly for English)
export function getPlural(count, singular, plural = null, language = currentLanguage) {
    if (language === 'en') {
        if (count === 1) return singular;
        return plural || `${singular}s`;
    } else {
        // Vietnamese doesn't have plural forms
        return singular;
    }
}

// Initialize translations on page load
export function initializeTranslations() {
    // Get saved language or detect from browser
    const savedLang = localStorage.getItem('language');
    const browserLang = navigator.language.startsWith('vi') ? 'vi' : 'en';
    const initialLang = savedLang || browserLang;
    
    setLanguage(initialLang);
    
    // Set up mutation observer for dynamic content
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    const translatableElements = node.querySelectorAll ? 
                        node.querySelectorAll('[data-translate]') : [];
                    
                    translatableElements.forEach(element => {
                        const key = element.getAttribute('data-translate');
                        const translation = t(key);
                        
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            if (element.type === 'submit' || element.type === 'button') {
                                element.value = translation;
                            } else {
                                element.placeholder = translation;
                            }
                        } else {
                            element.textContent = translation;
                        }
                    });
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}

// Language switching with smooth transitions
export function switchLanguageWithTransition(newLang) {
    if (newLang === currentLanguage) return;
    
    // Add transition class to body
    document.body.classList.add('language-switching');
    
    // Wait for CSS transition to start
    setTimeout(() => {
        setLanguage(newLang);
        translatePage();
        
        // Remove transition class after translation
        setTimeout(() => {
            document.body.classList.remove('language-switching');
        }, 100);
    }, 150);
}

// Export default object for easier importing
export default {
    translations,
    currentLanguage,
    t,
    setLanguage,
    getCurrentLanguage,
    getAvailableLanguages,
    translatePage,
    formatCurrency,
    formatDate,
    formatRelativeTime,
    getPlural,
    initializeTranslations,
    switchLanguageWithTransition
};
